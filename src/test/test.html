<!doctype html>
<html>
  <head>
    <title>SignalR Hub Tester</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
      }
      #log {
        border: 1px solid #ccc;
        padding: 10px;
        height: 300px;
        overflow-y: scroll;
      }
      input[type='text'] {
        width: 300px;
        margin-bottom: 10px;
      }
      textarea {
        width: 400px;
        height: 150px;
        margin-bottom: 10px;
        display: block;
      }
      button {
        margin: 5px;
      }
      hr {
        margin: 20px 0;
      }
      .section {
        margin-bottom: 20px;
        padding: 10px;
        border: 1px solid #eee;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <h2>SignalR Hub Tester</h2>

    <div>
      <label>Hub URL:</label>
      <input
        type="text"
        id="hubUrl"
        value="https://collabsphere.azurewebsites.net/KanbanServiceHub"
      />
    </div>
    <div>
      <label>JWT Token:</label>
      <input type="text" id="jwtToken" value="your_jwt_token_goes_here" />
    </div>
    <button id="connectBtn">Connect</button>
    <button id="disconnectBtn" disabled>Disconnect</button>

    <hr />

    <div class="section">
      <h3>1. Join Workspace</h3>
      <input
        type="text"
        id="workspaceId"
        placeholder="Workspace ID (e.g., 123)"
      />
      <button id="joinBtn">Join Workspace</button>
    </div>

    <div class="section">
      <h3>2. Leave Workspace</h3>
      <input
        type="text"
        id="leaveWorkspaceId"
        placeholder="Workspace ID (e.g., 123)"
      />
      <button id="leaveBtn">Leave Workspace</button>
    </div>

    <div class="section">
      <h3>3. Create List</h3>
      <input
        type="text"
        id="listTitle"
        placeholder="List Title (e.g., 'My List')"
      />
      <input type="text" id="listPos" placeholder="Position (e.g., 1.0)" />
      <button id="createListBtn">Create List</button>
    </div>

    <div class="section">
      <h3>4. Rename List</h3>
      <input type="text" id="listId" placeholder="List Id (e.g., 1,2,3)" />
      <input type="text" id="listNewTitle" placeholder="List new title" />
      <button id="renameListBtn">Rename List</button>
    </div>

    <div class="section">
      <h3>5. Move List</h3>
      <input type="text" id="moveListId" placeholder="List ID to move" />
      <input
        type="text"
        id="moveListNewPos"
        placeholder="New Position (e.g., 1.5)"
      />
      <button id="moveListBtn">Move List</button>
    </div>

    <div class="section">
      <h3>6. Create Card (with Assignments & Tasks)</h3>
      <input
        type="text"
        id="cardWorkspaceId"
        placeholder="Workspace ID (cho thẻ này)"
      />
      <input
        type="text"
        id="cardListId"
        placeholder="List ID (where to add card)"
      />
      <label>JSON Body (Copy JSON mẫu dán vào đây):</label>
      <textarea
        id="cardJsonBody"
        placeholder='{"cardTitle": "Demo Card", ...}'
      ></textarea>
      <button id="fillSampleJsonBtn">Điền JSON Mẫu</button>
      <button id="createCardBtn">Create Card</button>
    </div>

    <div class="section">
      <h3>7. Move Card</h3>
      <input
        type="text"
        id="moveCardCurrentListId"
        placeholder="Current List ID (e.g., 1)"
      />
      <input
        type="text"
        id="moveCardId"
        placeholder="Card ID to Move (e.g., 10)"
      />
      <input
        type="text"
        id="moveCardNewListId"
        placeholder="New List ID (e.g., 2)"
      />
      <input
        type="text"
        id="moveCardNewPosition"
        placeholder="New Position (e.g., 1.5)"
      />
      <button id="moveCardBtn">Move Card</button>
    </div>

    <div class="section">
      <h3>8. Update Card Details</h3>
      <input
        type="text"
        id="updateCardListId"
        placeholder="Current List ID (e.g., 1)"
      />
      <input
        type="text"
        id="updateCardId"
        placeholder="Card ID to Update (e.g., 10)"
      />
      <label>UpdateCardDetailsCommand JSON Body:</label>
      <textarea
        id="updateCardJsonBody"
        placeholder='{"CardTitle": "New Title", ...}'
      ></textarea>
      <button id="fillUpdateCardSampleJsonBtn">Điền JSON Mẫu</button>
      <button id="updateCardBtn">Update Card</button>
    </div>

    <div class="section">
      <h3>9. Mark/Unmark Card Complete</h3>
      <input
        type="text"
        id="markCardListId"
        placeholder="Current List ID (e.g., 1)"
      />
      <input type="text" id="markCardId" placeholder="Card ID (e.g., 10)" />
      <label
        ><input type="checkbox" id="markCardIsComplete" /> IsComplete (Check để
        set là True)</label
      >
      <button id="markCardBtn">Mark/Unmark Card</button>
    </div>

    <div class="section">
      <h3>10. Delete Card</h3>
      <input
        type="text"
        id="deleteCardListId"
        placeholder="Current List ID (e.g., 1)"
      />
      <input
        type="text"
        id="deleteCardId"
        placeholder="Card ID to Delete (e.g., 10)"
      />
      <button id="deleteCardBtn">Delete Card</button>
    </div>

    <div class="section">
      <h3>11. Assign Member to Card</h3>
      <input
        type="text"
        id="assignListId"
        placeholder="Current List ID (e.g., 1)"
      />
      <input type="text" id="assignCardId" placeholder="Card ID (e.g., 10)" />
      <input
        type="text"
        id="assignStudentId"
        placeholder="Student ID to Assign (e.g., 3)"
      />
      <input
        type="text"
        id="assignStudentName"
        placeholder="Student Name (e.g., 'Minh Tri')"
      />
      <button id="assignMemberBtn">Assign Member</button>
    </div>

    <div class="section">
      <h3>12. Unassign Member from Card</h3>
      <input
        type="text"
        id="unassignListId"
        placeholder="Current List ID (e.g., 1)"
      />
      <input type="text" id="unassignCardId" placeholder="Card ID (e.g., 10)" />
      <input
        type="text"
        id="unassignStudentId"
        placeholder="Student ID to Unassign (e.g., 3)"
      />
      <button id="unassignMemberBtn">Unassign Member</button>
    </div>

    <div class="section">
      <h3>13. Create Task (in Card)</h3>
      <input
        type="text"
        id="createTasklListId"
        placeholder="Current List ID (e.g., 1)"
      />
      <input
        type="text"
        id="createTaskCardId"
        placeholder="Card ID (e.g., 10)"
      />
      <input
        type="text"
        id="createTaskTitle"
        placeholder="Task Title (e.g., 'Do research')"
      />
      <button id="createTaskBtn">Create Task</button>
    </div>

    <div class="section">
      <h3>14. Rename Task</h3>
      <input
        type="text"
        id="renameTaskListId"
        placeholder="Current List ID (e.g., 1)"
      />
      <input
        type="text"
        id="renameTaskCardId"
        placeholder="Card ID (e.g., 10)"
      />
      <input type="text" id="renameTaskId" placeholder="Task ID (e.g., 20)" />
      <input type="text" id="renameTaskNewTitle" placeholder="New Task Title" />
      <button id="renameTaskBtn">Rename Task</button>
    </div>

    <div class="section">
      <h3>15. Delete Task</h3>
      <input
        type="text"
        id="deleteTaskListId"
        placeholder="Current List ID (e.g., 1)"
      />
      <input
        type="text"
        id="deleteTaskCardId"
        placeholder="Card ID (e.g., 10)"
      />
      <input
        type="text"
        id="deleteTaskId"
        placeholder="Task ID to Delete (e.g., 20)"
      />
      <button id="deleteTaskBtn">Delete Task</button>
    </div>

    <div class="section">
      <h3>16. Create SubTask</h3>
      <input
        type="text"
        id="createSubTaskListId"
        placeholder="Current List ID (e.g., 1)"
      />
      <input
        type="text"
        id="createSubTaskCardId"
        placeholder="Card ID (e.g., 10)"
      />
      <input
        type="text"
        id="createSubTaskTaskId"
        placeholder="Task ID (e.g., 20)"
      />
      <input
        type="text"
        id="createSubTaskTitle"
        placeholder="SubTask Title (e.g., 'Subtask 1.1')"
      />
      <label><input type="checkbox" id="createSubTaskIsDone" /> IsDone</label>
      <button id="createSubTaskBtn">Create SubTask</button>
    </div>

    <div class="section">
      <h3>17. Rename SubTask</h3>
      <input
        type="text"
        id="renameSubTaskListId"
        placeholder="Current List ID (e.g., 1)"
      />
      <input
        type="text"
        id="renameSubTaskCardId"
        placeholder="Card ID (e.g., 10)"
      />
      <input
        type="text"
        id="renameSubTaskTaskId"
        placeholder="Task ID (e.g., 20)"
      />
      <input
        type="text"
        id="renameSubTaskSubTaskId"
        placeholder="SubTask ID (e.g., 30)"
      />
      <input
        type="text"
        id="renameSubTaskNewTitle"
        placeholder="New SubTask Title"
      />
      <button id="renameSubTaskBtn">Rename SubTask</button>
    </div>

    <div class="section">
      <h3>18. Delete SubTask</h3>
      <input
        type="text"
        id="deleteSubTaskListId"
        placeholder="Current List ID (e.g., 1)"
      />
      <input
        type="text"
        id="deleteSubTaskCardId"
        placeholder="Card ID (e.g., 10)"
      />
      <input
        type="text"
        id="deleteSubTaskTaskId"
        placeholder="Task ID (e.g., 20)"
      />
      <input
        type="text"
        id="deleteSubTaskSubTaskId"
        placeholder="SubTask ID to Delete (e.g., 30)"
      />
      <button id="deleteSubTaskBtn">Delete SubTask</button>
    </div>

    <div class="section">
      <h3>19. Mark/Unmark SubTask</h3>
      <input
        type="text"
        id="markSubTaskListId"
        placeholder="Current List ID (e.g., 1)"
      />
      <input
        type="text"
        id="markSubTaskCardId"
        placeholder="Card ID (e.g., 10)"
      />
      <input
        type="text"
        id="markSubTaskTaskId"
        placeholder="Task ID (e.g., 20)"
      />
      <input
        type="text"
        id="markSubTaskSubTaskId"
        placeholder="SubTask ID (e.g., 30)"
      />
      <label
        ><input type="checkbox" id="markSubTaskIsDone" /> IsDone (Check để set
        là True)</label
      >
      <button id="markSubTaskBtn">Mark/Unmark SubTask</button>
    </div>

    <hr />

    <h3>Log (Sự kiện nhận được)</h3>
    <div id="log"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

    <script>
              // --- DOM Elements ---
              const hubUrlInput = document.getElementById("hubUrl");
              const jwtTokenInput = document.getElementById("jwtToken");
              const connectBtn = document.getElementById("connectBtn");
              const disconnectBtn = document.getElementById("disconnectBtn");
              const logDiv = document.getElementById("log");

              // Inputs
              const workspaceIdInput = document.getElementById("workspaceId");
              const leaveWorkspaceIdInput = document.getElementById("leaveWorkspaceId");
              const listTitleInput = document.getElementById("listTitle");
              const listPosInput = document.getElementById("listPos");
              const listId = document.getElementById("listId");
              const listNewTitle = document.getElementById("listNewTitle");
              const moveListIdInput = document.getElementById("moveListId");
              const moveListNewPosInput = document.getElementById("moveListNewPos");
              const cardWorkspaceIdInput = document.getElementById("cardWorkspaceId");
              const cardListIdInput = document.getElementById("cardListId");
              const cardJsonBodyInput = document.getElementById("cardJsonBody");
              const moveCardCurrentListIdInput = document.getElementById("moveCardCurrentListId");
              const moveCardIdInput = document.getElementById("moveCardId");
              const moveCardNewListIdInput = document.getElementById("moveCardNewListId");
              const moveCardNewPositionInput = document.getElementById("moveCardNewPosition");
              const updateCardListIdInput = document.getElementById("updateCardListId");
              const updateCardIdInput = document.getElementById("updateCardId");
              const updateCardJsonBodyInput = document.getElementById("updateCardJsonBody");
              const deleteCardListIdInput = document.getElementById("deleteCardListId");
              const deleteCardIdInput = document.getElementById("deleteCardId");
              const assignListIdInput = document.getElementById("assignListId");
              const assignCardIdInput = document.getElementById("assignCardId");
              const assignStudentIdInput = document.getElementById("assignStudentId");
              const assignStudentNameInput = document.getElementById("assignStudentName");
              const unassignListIdInput = document.getElementById("unassignListId");
              const unassignCardIdInput = document.getElementById("unassignCardId");
              const unassignStudentIdInput = document.getElementById("unassignStudentId");
              const createTasklListIdInput = document.getElementById("createTasklListId");
              const createTaskCardIdInput = document.getElementById("createTaskCardId");
              const createTaskTitleInput = document.getElementById("createTaskTitle");
              const renameTaskListIdInput = document.getElementById("renameTaskListId");
              const renameTaskCardIdInput = document.getElementById("renameTaskCardId");
              const renameTaskIdInput = document.getElementById("renameTaskId");
              const renameTaskNewTitleInput = document.getElementById("renameTaskNewTitle");
              const deleteTaskListIdInput = document.getElementById("deleteTaskListId");
              const deleteTaskCardIdInput = document.getElementById("deleteTaskCardId");
              const deleteTaskIdInput = document.getElementById("deleteTaskId");
              const createSubTaskListIdInput = document.getElementById("createSubTaskListId");
              const createSubTaskCardIdInput = document.getElementById("createSubTaskCardId");
              const createSubTaskTaskIdInput = document.getElementById("createSubTaskTaskId");
              const createSubTaskTitleInput = document.getElementById("createSubTaskTitle");
              const createSubTaskIsDoneInput = document.getElementById("createSubTaskIsDone");
              const renameSubTaskListIdInput = document.getElementById("renameSubTaskListId");
              const renameSubTaskCardIdInput = document.getElementById("renameSubTaskCardId");
              const renameSubTaskTaskIdInput = document.getElementById("renameSubTaskTaskId");
              const renameSubTaskSubTaskIdInput = document.getElementById("renameSubTaskSubTaskId");
              const renameSubTaskNewTitleInput = document.getElementById("renameSubTaskNewTitle");
              const deleteSubTaskListIdInput = document.getElementById("deleteSubTaskListId");
              const deleteSubTaskCardIdInput = document.getElementById("deleteSubTaskCardId");
              const deleteSubTaskTaskIdInput = document.getElementById("deleteSubTaskTaskId");
              const deleteSubTaskSubTaskIdInput = document.getElementById("deleteSubTaskSubTaskId");
              const markSubTaskListIdInput = document.getElementById("markSubTaskListId");
              const markSubTaskCardIdInput = document.getElementById("markSubTaskCardId");
              const markSubTaskTaskIdInput = document.getElementById("markSubTaskTaskId");
              const markSubTaskSubTaskIdInput = document.getElementById("markSubTaskSubTaskId");
              const markSubTaskIsDoneInput = document.getElementById("markSubTaskIsDone");

              // ⭐️ Input MỚI cho Mark/Unmark Card
              const markCardListIdInput = document.getElementById("markCardListId");
              const markCardIdInput = document.getElementById("markCardId");
              const markCardIsCompleteInput = document.getElementById("markCardIsComplete");

              // Buttons
              const joinBtn = document.getElementById("joinBtn");
              const leaveBtn = document.getElementById("leaveBtn");
              const createListBtn = document.getElementById("createListBtn");
              const renameListBtn = document.getElementById("renameListBtn");
              const moveListBtn = document.getElementById("moveListBtn");
              const createCardBtn = document.getElementById("createCardBtn");
              const fillSampleJsonBtn = document.getElementById("fillSampleJsonBtn");
              const moveCardBtn = document.getElementById("moveCardBtn");
              const updateCardBtn = document.getElementById("updateCardBtn");
              const fillUpdateCardSampleJsonBtn = document.getElementById("fillUpdateCardSampleJsonBtn");
              const deleteCardBtn = document.getElementById("deleteCardBtn");
              const assignMemberBtn = document.getElementById("assignMemberBtn");
              const unassignMemberBtn = document.getElementById("unassignMemberBtn");
              const createTaskBtn = document.getElementById("createTaskBtn");
              const renameTaskBtn = document.getElementById("renameTaskBtn");
              const deleteTaskBtn = document.getElementById("deleteTaskBtn");
              const createSubTaskBtn = document.getElementById("createSubTaskBtn");
              const renameSubTaskBtn = document.getElementById("renameSubTaskBtn");
              const deleteSubTaskBtn = document.getElementById("deleteSubTaskBtn");
              const markSubTaskBtn = document.getElementById("markSubTaskBtn");

              // ⭐️ Nút MỚI
              const markCardBtn = document.getElementById("markCardBtn");

              let connection = null;

              function log(message) {
                  logDiv.innerHTML = `<div><b>${new Date().toLocaleTimeString()}:</b> ${message}</div>` + logDiv.innerHTML;
              }

              // --- Nút Connect ---
              connectBtn.onclick = function () {
                  const hubUrl = hubUrlInput.value;
                  const token = jwtTokenInput.value;

                  if (!token || token === "your_jwt_token_goes_here") {
                      log("ERROR: Vui lòng nhập JWT Token.");
                      return;
                  }

                  connection = new signalR.HubConnectionBuilder()
                      .withUrl(hubUrl, { accessTokenFactory: () => token })
                      .withAutomaticReconnect()
                      .configureLogging(signalR.LogLevel.Information)
                      .build();

                  // --- Listeners (Lắng nghe sự kiện) ---

                  connection.on("ReceiveListCreated", (message) => {
                      log("EVENT RECEIVED: ReceiveListCreated");
                      try {
                          const data = JSON.parse(message);
                          log(JSON.stringify(data, null, 2));
                      } catch (e) { log(`Raw: ${message}`); }
                  });

                  connection.on("ReceiveListRenamed", (lId, newTitle) => {
                      log(`EVENT RECEIVED: ReceiveListRenamed (ID: ${lId}, NewTitle: ${newTitle})`);
                  });

                  connection.on("ReceiveListMoved", (lId, newPos) => {
                      log(`EVENT RECEIVED: ReceiveListMoved (ID: ${lId}, NewPos: ${newPos})`);
                  });

                  connection.on("ReceiveCardCreated", (lId, message) => {
                      log(`EVENT RECEIVED: ReceiveCardCreated (in List ID: ${lId})`);
                      try {
                          const cardData = JSON.parse(message);
                          log(JSON.stringify(cardData, null, 2));
                      } catch (e) {
                          log(`Raw Message: ${message}`);
                      }
                  });

                  connection.on("ReceiveCardMoved", (cardId, newListId, newPosition) => {
                      log(`EVENT RECEIVED: ReceiveCardMoved | Card ID: ${cardId}, New List ID: ${newListId}, New Position: ${newPosition}`);
                  });

                  connection.on("ReceiveCardUpdated", (cardId, message) => {
                      log(`EVENT RECEIVED: ReceiveCardUpdated (Card ID: ${cardId})`);
                       try {
                          const updatedData = JSON.parse(message);
                          log(JSON.stringify(updatedData, null, 2));
                      } catch (e) {
                          log(`Raw Message: ${message}`);
                      }
                  });

                  // ⭐️ Listener MỚI cho Mark/Unmark Card
                  // BE: SendAsync("ReceiveCardComplete", command.ListId, command.CardId, command.IsComplete)
                  connection.on("ReceiveCardComplete", (listId, cardId, isComplete) => {
                      log(`EVENT RECEIVED: ReceiveCardComplete (List: ${listId}, Card: ${cardId})`);
                      log(`New IsComplete status: ${isComplete}`);
                  });

                  connection.on("ReceiveCardDeleted", (listId, cardId) => {
                      log(`EVENT RECEIVED: ReceiveCardDeleted (List ID: ${listId}, Card ID: ${cardId})`);
                  });

                  connection.on("ReceiveCardAssigned", (listId, cardId, message) => {
                      log(`EVENT RECEIVED: ReceiveCardAssigned (List: ${listId}, Card: ${cardId})`);
                      try {
                          const assignData = JSON.parse(message);
                          log(JSON.stringify(assignData, null, 2));
                      } catch (e) { log(`Raw Message: ${message}`); }
                  });

                  connection.on("ReceiveCardUnAssigned", (listId, cardId, studentId) => {
                      log(`EVENT RECEIVED: ReceiveCardUnAssigned (List: ${listId}, Card: ${cardId}, Student: ${studentId})`);
                  });

                  connection.on("ReceiveTaskCreated", (listId, cardId, message) => {
                      log(`EVENT RECEIVED: ReceiveTaskCreated (List: ${listId}, Card: ${cardId})`);
                      try {
                          const taskData = JSON.parse(message);
                          log(JSON.stringify(taskData, null, 2));
                      } catch (e) { log(`Raw Message: ${message}`); }
                  });

                  connection.on("ReceiveTaskRenamed", (listId, cardId, taskId, newTitle) => {
                      log(`EVENT RECEIVED: ReceiveTaskRenamed (List: ${listId}, Card: ${cardId}, Task: ${taskId})`);
                      log(`New Title: ${newTitle}`);
                  });

                  connection.on("ReceiveTaskDeleted", (listId, cardId, taskId) => {
                      log(`EVENT RECEIVED: ReceiveTaskDeleted (List: ${listId}, Card: ${cardId}, Task: ${taskId})`);
                  });

                  connection.on("ReceiveSubTaskCreated", (listId, cardId, taskId, message) => {
                      log(`EVENT RECEIVED: ReceiveSubTaskCreated (List: ${listId}, Card: ${cardId}, Task: ${taskId})`);
                      try {
                          const subTaskData = JSON.parse(message);
                          log(JSON.stringify(subTaskData, null, 2));
                      } catch (e) { log(`Raw Message: ${message}`); }
                  });

                  connection.on("ReceiveSubTaskRenamed", (listId, cardId, taskId, subTaskId, newTitle) => {
                      log(`EVENT RECEIVED: ReceiveSubTaskRenamed (List: ${listId}, Card: ${cardId}, Task: ${taskId}, SubTask: ${subTaskId})`);
                      log(`New Title: ${newTitle}`);
                  });

                  connection.on("ReceiveSubTaskDeleted", (listId, cardId, taskId, subTaskId) => {
                      log(`EVENT RECEIVED: ReceiveSubTaskDeleted (List: ${listId}, Card: ${cardId}, Task: ${taskId}, SubTask: ${subTaskId})`);
                  });

                  connection.on("ReceiveSubTaskMarkDone", (listId, cardId, taskId, subTaskId, isDone) => {
                      log(`EVENT RECEIVED: ReceiveSubTaskMarkDone (List: ${listId}, Card: ${cardId}, Task: ${taskId}, SubTask: ${subTaskId})`);
                      log(`New IsDone status: ${isDone}`);
                  });

                  // --- Bắt đầu kết nối ---
                  connection.start()
                      .then(() => {
                          log("Connected!");
                          connectBtn.disabled = true;
                          disconnectBtn.disabled = false;
                      })
                      .catch(err => {
                          log("Connection failed: " + err.toString());
                      });
              };

              // --- Nút Disconnect ---
              disconnectBtn.onclick = function () {
                  if (connection) {
                      connection.stop().then(() => {
                          log("Disconnected.");
                          connectBtn.disabled = false;
                          disconnectBtn.disabled = true;
                      });
                  }
              };

              // Helper check kết nối
              function checkConn() {
                  if (!connection || connection.state !== "Connected") {
                      log("ERROR: Chưa kết nối (Not Connected).");
                      return false;
                  }
                  return true;
              }

              // --- 1. Join Workspace ---
              joinBtn.onclick = function () {
                  const workspaceId = parseInt(workspaceIdInput.value);
                  if (!checkConn() || !workspaceId) { log("ERROR: Nhập Workspace ID."); return; }
                  log(`Calling 'JoinWorkspace' (${workspaceId})...`);
                  connection.invoke("JoinWorkspace", workspaceId)
                      .then(() => log("Đã Join Workspace!"))
                      .catch(err => log("Lỗi: " + err.toString()));
              };

              // --- 2. Leave Workspace ---
              leaveBtn.onclick = function () {
                  const workspaceId = parseInt(leaveWorkspaceIdInput.value);
                  if (!checkConn() || !workspaceId) { log("ERROR: Nhập Workspace ID."); return; }
                  log(`Calling 'LeaveWorkspace' (${workspaceId})...`);
                  connection.invoke("LeaveWorkspace", workspaceId)
                      .then(() => log("Đã leave Workspace!"))
                      .catch(err => log("Lỗi: " + err.toString()));
              };

              // --- 3. Create List ---
              createListBtn.onclick = function () {
                  const workspaceId = parseInt(workspaceIdInput.value);
                  const title = listTitleInput.value;
                  const position = parseFloat(listPosInput.value);
                  if (!checkConn() || !workspaceId || !title) { log("ERROR: Nhập Workspace ID và Title."); return; }
                  const cmd = { title: title, position: position };
                  log("Calling 'CreateList'...");
                  connection.invoke("CreateList", workspaceId, cmd)
                      .then(() => log("Sent CreateList command."))
                      .catch(err => log("Lỗi: " + err.toString()));
              };

              // --- 4. Rename List ---
              renameListBtn.onclick = function() {
                  const workspaceId = parseInt(workspaceIdInput.value);
                  const listIdValue = parseInt(listId.value);
                  const newTitleValue = listNewTitle.value;
                  if (!checkConn() || !workspaceId || !listIdValue) { log("ERROR: Nhập đủ thông tin."); return; }
                  const cmd = { newTitle: newTitleValue };
                  log("Calling 'RenameList'...");
                  connection.invoke("RenameList", workspaceId, listIdValue, cmd)
                      .then(() => log("Sent RenameList command."))
                      .catch(err => log("Lỗi: " + err.toString()));
              };

              // --- 5. Move List ---
              moveListBtn.onclick = function() {
                  const workspaceId = parseInt(workspaceIdInput.value);
                  const listIdValue = parseInt(moveListIdInput.value);
                  const newPositionValue = parseFloat(moveListNewPosInput.value);
                  if (!checkConn() || !workspaceId || !listIdValue) { log("ERROR: Nhập đủ thông tin."); return; }
                  const cmd = { newPosition: newPositionValue };
                  log("Calling 'MoveList'...");
                  connection.invoke("MoveList", workspaceId, listIdValue, cmd)
                      .then(() => log("Sent MoveList command."))
                      .catch(err => log("Lỗi: " + err.toString()));
              };

              // --- 6. Create Card ---
              fillSampleJsonBtn.onclick = function() {
                  const sample = {
                      "cardTitle": "Thẻ Test Mới", "cardDescription": "Mô tả thẻ test", "riskLevel": "Normal", "position": 1.0, "isComplete": false, "dueAt": null,
                      "assignmentList": [ { "studentId": 3, "studentName": "MINH TRÍ 666" } ],
                      "tasksOfCard": [ { "taskTitle": "Task 1", "taskOrder": 1, "subTaskOfCard":[] } ]
                          // {
      //     [Required]
      //     public string SubTaskTitle { get; set; } = string.Empty;
      //     [Required]
      //     public int SubTaskOrder { get; set; }
      //     [Required]
      //     public bool IsDone { get; set; }
      // }]
      
                  };
                  cardJsonBodyInput.value = JSON.stringify(sample, null, 2);
              };

              createCardBtn.onclick = function() {
                  const wsId = parseInt(cardWorkspaceIdInput.value);
                  const targetListId = parseInt(cardListIdInput.value);
                  const jsonText = cardJsonBodyInput.value;

                  if (!checkConn() || !wsId || !targetListId) { log("ERROR: Vui lòng nhập Workspace ID và List ID."); return; }
                  if (!jsonText) { log("ERROR: Vui lòng nhập JSON Body."); return; }

                  let createCardCommand;
                  try {
                      createCardCommand = JSON.parse(jsonText);
                  } catch (e) {
                      log("ERROR: JSON Body không hợp lệ. Kiểm tra lại cú pháp.");
                      return;
                  }
                  log("Calling 'CreateCardAndAssignMember'...");
                  connection.invoke("CreateCardAndAssignMember", wsId, targetListId, createCardCommand)
                      .then(() => log("Sent CreateCardAndAssignMember command success!"))
                      .catch(err => log("Lỗi CreateCard: " + err.toString()));
              };

              // --- 7. Move Card ---
              moveCardBtn.onclick = function() {
                  const workspaceId = parseInt(workspaceIdInput.value);
                  const currentListId = parseInt(moveCardCurrentListIdInput.value);
                  const cardId = parseInt(moveCardIdInput.value);
                  const newListId = parseInt(moveCardNewListIdInput.value);
                  const newPosition = parseFloat(moveCardNewPositionInput.value);

                  if (!checkConn()) return;
                  if (!workspaceId || !currentListId || !cardId || !newListId || isNaN(newPosition)) {
                      log("ERROR: Vui lòng nhập đầy đủ Workspace ID, Current List ID, Card ID, New List ID, và New Position.");
                      return;
                  }

                  const moveCardCommand = {
                      newListId: newListId,
                      newPosition: newPosition
                  };

                  log("Calling 'MoveCard'...");
                  connection.invoke("MoveCard", workspaceId, currentListId, cardId, moveCardCommand)
                      .then(() => log("Sent MoveCard command success!"))
                      .catch(err => log("Lỗi MoveCard: " + err.toString()));
              };

              // --- 8. Update Card Details ---
              fillUpdateCardSampleJsonBtn.onclick = function() {
                  const sample = {
                      "CardTitle": "Updated Card Title",
                      "CardDescription": "This description has been updated.",
                      "RiskLevel": "Low",
                      "DueAt": "2025-01-01T12:00:00Z"
                  };
                  updateCardJsonBodyInput.value = JSON.stringify(sample, null, 2);
              };

              updateCardBtn.onclick = function() {
                  const workspaceId = parseInt(workspaceIdInput.value);
                  const listId = parseInt(updateCardListIdInput.value);
                  const cardId = parseInt(updateCardIdInput.value);
                  const jsonText = updateCardJsonBodyInput.value;

                  if (!checkConn()) return;
                  if (!workspaceId || !listId || !cardId) {
                      log("ERROR: Vui lòng nhập Workspace ID, List ID, và Card ID.");
                      return;
                  }
                  if (!jsonText) {
                      log("ERROR: Vui lòng nhập JSON Body cho UpdateCardDetailsCommand.");
                      return;
                  }

                  let updateCardCommand;
                  try {
                      updateCardCommand = JSON.parse(jsonText);
                  } catch (e) {
                      log("ERROR: JSON Body không hợp lệ: " + e.message);
                      return;
                  }

                  log("Calling 'UpdateCardDetails'...");
                  connection.invoke("UpdateCardDetails", workspaceId, listId, cardId, updateCardCommand)
                      .then(() => log("Sent UpdateCardDetails command success!"))
                      .catch(err => log("Lỗi UpdateCardDetails: " + err.toString()));
              };

              // ⭐️ 9. Mark/Unmark Card Complete (HÀM MỚI)
              markCardBtn.onclick = function() {
                  // Lấy Workspace ID từ ô input chung (section 1)
                  const workspaceId = parseInt(workspaceIdInput.value);

                  // Lấy các ID từ ô input của section "Mark/Unmark Card"
                  const listId = parseInt(markCardListIdInput.value);
                  const cardId = parseInt(markCardIdInput.value);
                  const isComplete = markCardIsCompleteInput.checked; // Lấy giá trị boolean từ checkbox

                  if (!checkConn()) return;
                  if (!workspaceId || !listId || !cardId) {
                      log("ERROR: Vui lòng nhập Workspace ID, List ID, và Card ID.");
                      return;
                  }

                  // Command object (dựa trên C# DTO của bạn)
                  const markUnMarkCompleteCardCommand = {
                      IsComplete: isComplete
                  };

                  log("Calling 'MarkUnMarkCompleteCard'...");

                  // Gọi Hub: (int workspaceId, int listId, int cardId, MarkUnMarkCompleteCardCommand command)
                  connection.invoke("MarkUnMarkCompleteCard", workspaceId, listId, cardId, markUnMarkCompleteCardCommand)
                      .then(() => log("Sent MarkUnMarkCompleteCard command success!"))
                      .catch(err => log("Lỗi MarkUnMarkCompleteCard: " + err.toString()));
              };

              // --- 10. Delete Card ---
              deleteCardBtn.onclick = function() {
                  const workspaceId = parseInt(workspaceIdInput.value);
                  const listId = parseInt(deleteCardListIdInput.value);
                  const cardId = parseInt(deleteCardIdInput.value);

                  if (!checkConn()) return;
                  if (!workspaceId || !listId || !cardId) {
                      log("ERROR: Vui lòng nhập Workspace ID, List ID, và Card ID.");
                      return;
                  }

                  const deleteCardCommand = {};

                  log("Calling 'DeleteCard'...");
                  connection.invoke("DeleteCard", workspaceId, listId, cardId, deleteCardCommand)
                      .then(() => log("Sent DeleteCard command success!"))
                      .catch(err => log("Lỗi DeleteCard: " + err.toString()));
              };

              // --- 11. Assign Member ---
              assignMemberBtn.onclick = function() {
                  const workspaceId = parseInt(workspaceIdInput.value);

                  const listId = parseInt(assignListIdInput.value);
                  const cardId = parseInt(assignCardIdInput.value);
                  const studentId = parseInt(assignStudentIdInput.value);
                  const studentName = assignStudentNameInput.value;

                  if (!checkConn()) return;
                  if (!workspaceId || !listId || !cardId || !studentId || !studentName) {
                      log("ERROR: Vui lòng nhập Workspace ID, List ID, Card ID, Student ID, và Student Name.");
                      return;
                  }

                  const assignCommand = {
                      StudentId: studentId,
                      StudentName: studentName
                  };

                  log("Calling 'AssignMembersToCard'...");

                  connection.invoke("AssignMembersToCard", workspaceId, listId, cardId, assignCommand)
                      .then(() => log("Sent AssignMembersToCard command success!"))
                      .catch(err => log("Lỗi AssignMember: " + err.toString()));
              };

              // --- 12. Unassign Member ---
              unassignMemberBtn.onclick = function() {
                  const workspaceId = parseInt(workspaceIdInput.value);

                  const listId = parseInt(unassignListIdInput.value);
                  const cardId = parseInt(unassignCardIdInput.value);
                  const studentId = parseInt(unassignStudentIdInput.value);

                  if (!checkConn()) return;
                  if (!workspaceId || !listId || !cardId || !studentId) {
                      log("ERROR: Vui lòng nhập Workspace ID, List ID, Card ID, và Student ID.");
                      return;
                  }

                  const unassignCommand = {
                      StudentId: studentId
                  };

                  log("Calling 'UnAssignMembersToCard'...");

                  connection.invoke("UnAssignMembersToCard", workspaceId, listId, cardId, unassignCommand)
                      .then(() => log("Sent UnAssignMembersToCard command success!"))
                      .catch(err => log("Lỗi UnAssignMember: " + err.toString()));
              };

              // --- 13. Create Task ---
              createTaskBtn.onclick = function() {
                  const workspaceId = parseInt(workspaceIdInput.value);

                  const listId = parseInt(createTasklListIdInput.value);
                  const cardId = parseInt(createTaskCardIdInput.value);
                  const taskTitle = createTaskTitleInput.value;

                  if (!checkConn()) return;
                  if (!workspaceId || !listId || !cardId || !taskTitle) {
                      log("ERROR: Vui lòng nhập Workspace ID, List ID, Card ID, và Task Title.");
                      return;
                  }

                  const createTaskCommand = {
                      TaskTitle: taskTitle
                  };

                  log("Calling 'CreateTask'...");

                  connection.invoke("CreateTask", workspaceId, listId, cardId, createTaskCommand)
                      .then(() => log("Sent CreateTask command success!"))
                      .catch(err => log("Lỗi CreateTask: " + err.toString()));
              };

              // --- 14. Rename Task ---
              renameTaskBtn.onclick = function() {
                  const workspaceId = parseInt(workspaceIdInput.value);

                  const listId = parseInt(renameTaskListIdInput.value);
                  const cardId = parseInt(renameTaskCardIdInput.value);
                  const taskId = parseInt(renameTaskIdInput.value);
                  const newTitle = renameTaskNewTitleInput.value;

                  if (!checkConn()) return;
                  if (!workspaceId || !listId || !cardId || !taskId || !newTitle) {
                      log("ERROR: Vui lòng nhập Workspace ID, List ID, Card ID, Task ID, và New Title.");
                      return;
                  }

                  const renameTaskCommand = {
                      NewTitle: newTitle
                  };

                  log("Calling 'RenameTask'...");

                  connection.invoke("RenameTask", workspaceId, listId, cardId, taskId, renameTaskCommand)
                      .then(() => log("Sent RenameTask command success!"))
                      .catch(err => log("Lỗi RenameTask: " + err.toString()));
              };

              // --- 15. Delete Task ---
              deleteTaskBtn.onclick = function() {
                  const workspaceId = parseInt(workspaceIdInput.value);

                  const listId = parseInt(deleteTaskListIdInput.value);
                  const cardId = parseInt(deleteTaskCardIdInput.value);
                  const taskId = parseInt(deleteTaskIdInput.value);

                  if (!checkConn()) return;
                  if (!workspaceId || !listId || !cardId || !taskId) {
                      log("ERROR: Vui lòng nhập Workspace ID, List ID, Card ID, và Task ID.");
                      return;
                  }

                  const deleteTaskCommand = {};

                  log("Calling 'DeleteTask'...");

                  connection.invoke("DeleteTask", workspaceId, listId, cardId, taskId, deleteTaskCommand)
                      .then(() => log("Sent DeleteTask command success!"))
                      .catch(err => log("Lỗi DeleteTask: " + err.toString()));
              };

              // --- 16. Create SubTask ---
              createSubTaskBtn.onclick = function() {
                  const workspaceId = parseInt(workspaceIdInput.value);

                  const listId = parseInt(createSubTaskListIdInput.value);
                  const cardId = parseInt(createSubTaskCardIdInput.value);
                  const taskId = parseInt(createSubTaskTaskIdInput.value);
                  const subTaskTitle = createSubTaskTitleInput.value;
                  const isDone = createSubTaskIsDoneInput.checked;

                  if (!checkConn()) return;
                  if (!workspaceId || !listId || !cardId || !taskId || !subTaskTitle) {
                      log("ERROR: Vui lòng nhập Workspace ID, List ID, Card ID, Task ID, và SubTask Title.");
                      return;
                  }

                  const createSubTaskCommand = {
                      SubTaskTitle: subTaskTitle,
                      IsDone: isDone
                  };

                  log("Calling 'CreateSubTask'...");

                  connection.invoke("CreateSubTask", workspaceId, listId, cardId, taskId, createSubTaskCommand)
                      .then(() => log("Sent CreateSubTask command success!"))
                      .catch(err => log("Lỗi CreateSubTask: " + err.toString()));
              };

              // --- 17. Rename SubTask ---
              renameSubTaskBtn.onclick = function() {
                  const workspaceId = parseInt(workspaceIdInput.value);

                  const listId = parseInt(renameSubTaskListIdInput.value);
                  const cardId = parseInt(renameSubTaskCardIdInput.value);
                  const taskId = parseInt(renameSubTaskTaskIdInput.value);
                  const subTaskId = parseInt(renameSubTaskSubTaskIdInput.value);
                  const newTitle = renameSubTaskNewTitleInput.value;

                  if (!checkConn()) return;
                  if (!workspaceId || !listId || !cardId || !taskId || !subTaskId || !newTitle) {
                      log("ERROR: VVui lòng nhập Workspace ID, List ID, Card ID, Task ID, SubTask ID, và New Title.");
                      return;
                  }

                  const renameSubTaskCommand = {
                      SubTaskNewTitle: newTitle
                  };

                  log("Calling 'RenameSubTask'...");

                  connection.invoke("RenameSubTask", workspaceId, listId, cardId, taskId, subTaskId, renameSubTaskCommand)
                      .then(() => log("Sent RenameSubTask command success!"))
                      .catch(err => log("Lỗi RenameSubTask: " + err.toString()));
              };

              // --- 18. Delete SubTask ---
              deleteSubTaskBtn.onclick = function() {
                  const workspaceId = parseInt(workspaceIdInput.value);

                  const listId = parseInt(deleteSubTaskListIdInput.value);
                  const cardId = parseInt(deleteSubTaskCardIdInput.value);
                  const taskId = parseInt(deleteSubTaskTaskIdInput.value);
                  const subTaskId = parseInt(deleteSubTaskSubTaskIdInput.value);

                  if (!checkConn()) return;
                  if (!workspaceId || !listId || !cardId || !taskId || !subTaskId) {
                      log("ERROR: Vui lòng nhập Workspace ID, List ID, Card ID, Task ID, và SubTask ID.");
                      return;
                  }

                  const deleteSubTaskCommand = {};

                  log("Calling 'DeleteSubTask'...");

                  connection.invoke("DeleteSubTask", workspaceId, listId, cardId, taskId, subTaskId, deleteSubTaskCommand)
                      .then(() => log("Sent DeleteSubTask command success!"))
                      .catch(err => log("Lỗi DeleteSubTask: " + err.toString()));
              };

              // --- 19. Mark/Unmark SubTask ---
              markSubTaskBtn.onclick = function() {
                  const workspaceId = parseInt(workspaceIdInput.value);

                  const listId = parseInt(markSubTaskListIdInput.value);
                  const cardId = parseInt(markSubTaskCardIdInput.value);
                  const taskId = parseInt(markSubTaskTaskIdInput.value);
                  const subTaskId = parseInt(markSubTaskSubTaskIdInput.value);
                  const isDone = markSubTaskIsDoneInput.checked;

                  if (!checkConn()) return;
                  if (!workspaceId || !listId || !cardId || !taskId || !subTaskId) {
                      log("ERROR: Vui lòng nhập Workspace ID, List ID, Card ID, Task ID, và SubTask ID.");
                      return;
                  }

                  const markUnMarkdoneSubTaskCommand = {
                      IsDone: isDone
                  };

                  log("Calling 'MarkUnMarkdoneSubTask'...");

                  connection.invoke("MarkUnMarkdoneSubTask", workspaceId, listId, cardId, taskId, subTaskId, markUnMarkdoneSubTaskCommand)
                      .then(() => log("Sent MarkUnMarkdoneSubTask command success!"))
                      .catch(err => log("Lỗi MarkUnMarkdoneSubTask: " + err.toString()));
              };
    </script>
  </body>
</html>
